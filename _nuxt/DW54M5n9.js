import{_ as At}from"./K_zvSPJA.js";import{_ as St}from"./CH0ThVOt.js";import{f as Rt,y as Ct,z as Dt,h as m,A as z,B as Tt,C as Nt,i as Mt,D as Bt,E as Lt,r as I,o as b,c as w,a as u,b as N,w as Y,F as ct,k as Et,t as $,d as V,l as Z,e as qt,p as zt}from"./BJdbIX9c.js";import{S as It,l as Vt,q as J}from"./C4tfgTo-.js";import{t as Q,s as A}from"./DkrfxnvH.js";import{f as ut}from"./D2nGpDRe.js";import{p as jt}from"./Drloq0xg.js";import{_ as Wt}from"./DlAUqK2U.js";import"./FOedhIC0.js";import"./yHBgcFlJ.js";const Ft={class:"sankey-page"},Pt={class:"section"},Ut={class:"container"},Gt={class:"level mb-5"},Ot={class:"level-left"},Ht={class:"is-flex is-align-items-center"},Kt={key:0,class:"icon is-small mr-1"},Xt={class:"level-right"},Yt={style:{"min-width":"250px"}},Zt={class:"mb-1 is-size-7 has-text-weight-bold"},Jt={key:0,class:"notification is-info is-light"},Qt={key:1,class:"notification is-danger"},te={class:"section p-0",style:{position:"relative",overflow:"hidden","min-height":"500px"}},ee=["width","height"],ne={class:"card-content p-3"},oe={class:"title is-6 mb-1"},ae={class:"content is-small"},se={class:"mb-0"},dt="/commit_rates",ht="2018-01-01",pt=300,ie=Rt({__name:"commit-rates-sankey",setup(re){const j=Ct(),W=Dt(),y=m("chromium"),x=m("."),S=m(40),f=m(1200),F=m(800),M=m(!1),R=m(null),C=m(null),tt=m(null),et=m(null),P=m(null),g=m(null),B=m({name:"",path:"",value:0,percent:""}),L=new Map,_=new Map;let U=0;z(()=>new Date(ht).getFullYear());const mt=z(()=>{const e=new Date(ht),i=Math.abs(new Date().getTime()-e.getTime());return Math.floor(Math.ceil(i/(1e3*60*60*24))/7)}),nt=z({get:()=>[y.value],set:e=>{if(e&&e.length>0){const t=e[0],i=typeof t=="object"?t.name:t;i&&i!==y.value&&W.push({query:{repository:i,path:"."}})}}}),ot=z(()=>{const t=[{label:y.value,path:"."}];if(x.value&&x.value!=="."){const i=x.value.split("/");let s="";i.forEach(r=>{s=s?`${s}/${r}`:r,t.push({label:r,path:s})})}return t}),vt=e=>!e.cone;function yt(e){W.push({query:{...j.query,path:e}})}const ft=ut(",");function E(e){return ft(Math.round(e))}ut(".1%");function gt(e){let t=5381;for(let i=0;i<e.length;i++)t=(t<<5)+t^e.charCodeAt(i),t=t|0;return(t>>>0)%2048}function bt(e){if(!e||e.length===0)return[];let t=0;for(let s=0;s<e.length;s+=2){const r=e[s],l=e[s+1];if(l&&l.length){const d=r+l.length;d>t&&(t=d)}}const i=new Array(t).fill(0);for(let s=0;s<e.length;s+=2){const r=e[s],l=e[s+1];if(l)for(let d=0;d<l.length;d++)i[r+d]=l[d]}for(;i.length<mt.value;)i.push(0);return i}function xt(e,t){if(t<=1)return e;const i=[];let s=0;for(let r=0;r<e.length;r++)s+=e[r],r>=t&&(s-=e[r-t]),i.push(s);return i}function at(e){const t=e.source,i=e.target,s=t.x1,r=i.x0,l=(s+r)/2,d=e.y0-(e.width||0)/2,p=e.y1-(e.width||0)/2,c=e.y0+(e.width||0)/2,v=e.y1+(e.width||0)/2;return`M${s},${d}
          C${l},${d} ${l},${p} ${r},${p}
          L${r},${v}
          C${l},${v} ${l},${c} ${s},${c}
          Z`}function st(e,t){if(t===".")return`${dt}/${e}/main.json`;const i=gt(t);return`${dt}/${e}/${i}.json`}function it(e,t){if(_.has(t))return _.get(t);const i=fetch(t).then(async s=>{if(!s.ok)throw new Error(`Failed to load bucket (Status: ${s.status})`);return s.json()}).catch(s=>{throw _.delete(t),s});return _.set(t,i),i}function _t(e,t){for(const i of t){const s=st(e,i);_.has(s)||it(e,s).catch(()=>{})}}async function kt(e,t){const i=`${e}:${t}`;if(L.has(i))return L.get(i);const s=st(e,t);try{const l=(await it(e,s))[t];if(!l)return[];const d=Object.entries(l).map(([p,c])=>{if(c.d&&typeof c.d=="number")return null;const k=(typeof c.d=="number"?c.d:null)!==null;return{name:p,path:t==="."?p:`${t}/${p}`,rates:bt(c.r),isDirectory:c.f==null||c.f!=1,isDeleted:k}}).filter(Boolean);return L.set(i,d),d}catch(r){throw console.error(`Error fetching path ${t}:`,r),r}}function wt(e){if(!e||e.length===0)return 0;const t=xt(e,S.value);return t[t.length-1]||0}async function $t(e){const t=[],i=[],s=new Map,r=e==="."?y.value:e.split("/").pop();t.push({node:0,name:r,path:e,activity:0,height:0,depth:0}),s.set(e,0);const l=[e];for(;l.length>0&&t.length<pt;){const d=l.slice(0,5);d.length>0&&_t(y.value,d);const p=l.shift(),c=s.get(p),v=await kt(y.value,p);if(!v.length)continue;const k=v.map(n=>({...n,activity:wt(n.rates)})).filter(n=>n.activity>0&&!n.isDeleted);k.sort((n,h)=>h.activity-n.activity);const X=k.slice(0,20),D=X.reduce((n,h)=>n+h.activity,0),a=t[c];c===0&&(a.activity=D,a.height=D);const o=a.height;for(const n of X){const h=t.length;let T=0;D>0&&(T=n.activity/D*o),t.push({node:h,name:n.name,path:n.path,activity:n.activity,height:T,depth:a.depth+1,parent:c}),s.set(n.path,h),i.push({source:c,target:h,value:T}),n.isDirectory&&t.length<pt&&l.push(n.path)}}return{nodes:t,links:i}}const q=Tt(Nt);async function G(){if(!C.value)return;const e=++U;M.value=!0,R.value=null;try{const{nodes:t,links:i}=await $t(x.value);if(e!==U||!C.value)return;if(t.length<=1){R.value="No active data found for this path.",M.value=!1;return}f.value=Math.min(window.innerWidth-40,1600),F.value=t.length*10+25;const r=It().nodeWidth(50).nodePadding(5).nodeAlign(Vt).extent([[1,1],[f.value-1,F.value-6]]).nodeSort((a,o)=>{let n=a,h=o;for(;n&&h&&n.parent!==void 0&&h.parent!==void 0&&n.parent===h.parent;)n=t[n.parent],h=t[h.parent];return n&&h&&n.parent!==void 0&&h.parent!==void 0?n.parent-h.parent:0}).linkSort((a,o)=>{const n=a.target;return(o.target.height||0)-(n.height||0)})({nodes:t.map(a=>({...a})),links:i.map(a=>({...a}))}),l=300,d=Q().ease(J).duration(l),p=Q().ease(J).duration(l).delay(3*l/2),c=Q().ease(J).duration(l);A(et.value).selectAll("rect").data(r.nodes,a=>a.path).join(a=>a.append("rect").attr("x",o=>o.x0).attr("y",o=>o.y0).attr("height",o=>Math.max(1,o.y1-o.y0)).attr("width",o=>o.x1-o.x0).attr("fill",o=>q(o.name)).attr("rx",2).attr("opacity",0).call(o=>o.transition(p).attr("opacity",.9)),a=>a.transition(d).attr("x",o=>o.x0).attr("y",o=>o.y0).attr("height",o=>Math.max(1,o.y1-o.y0)).attr("width",o=>o.x1-o.x0).attr("fill",o=>q(o.name)).attr("opacity",.9),a=>a.transition(c).attr("opacity",0).remove()).attr("cursor","pointer").on("click",(a,o)=>{W.push({query:{...j.query,path:o.path}})}).on("mouseover",(a,o)=>rt(a,o,r.nodes[0].activity||0)).on("mousemove",O).on("mouseout",lt),A(tt.value).selectAll("path").data(r.links,a=>{const o=a.source,n=a.target;return`${o.path}->${n.path}`}).join(a=>a.append("path").attr("d",at).attr("stroke","none").attr("fill",o=>q(o.source.name)).attr("opacity",0).call(o=>o.transition(p).attr("opacity",.3)),a=>a.transition(d).attr("d",at).attr("fill",o=>q(o.source.name)).attr("opacity",.3),a=>a.transition(c).attr("opacity",0).remove()).style("mix-blend-mode","multiply").on("mouseover",function(a,o){A(this).attr("opacity",.7),rt(a,o.target,r.nodes[0].activity||0)}).on("mousemove",O).on("mouseout",function(){A(this).attr("opacity",.3),lt()}),A(P.value).selectAll("text.name-label").data(r.nodes,a=>a.path).join(a=>{const o=a.append("text").attr("class","name-label").attr("x",n=>n.x0<f.value/2?n.x1+6:n.x0-6).attr("y",n=>(n.y1+n.y0)/2).attr("dy","0.35em").attr("text-anchor",n=>n.x0<f.value/2?"start":"end").attr("opacity",0).text(n=>n.name);return o.transition(p).attr("opacity",1),o},a=>a.transition(d).attr("x",n=>n.x0<f.value/2?n.x1+6:n.x0-6).attr("y",n=>(n.y1+n.y0)/2).attr("text-anchor",n=>n.x0<f.value/2?"start":"end").text(n=>n.name),a=>a.transition(c).attr("opacity",0).remove()).attr("pointer-events","none").style("display",a=>a.y1-a.y0>12?"block":"none"),A(P.value).selectAll("text.value-label").data(r.nodes,a=>a.path).join(a=>{const o=a.append("text").attr("class","value-label").attr("x",n=>(n.x0+n.x1)/2).attr("y",n=>(n.y0+n.y1)/2).attr("dy","0.35em").attr("text-anchor","middle").attr("opacity",0).style("font-size","11px").style("font-weight","bold").style("fill","#fff").style("pointer-events","none").style("text-shadow","0px 0px 3px rgba(0,0,0,0.8)").text(n=>E(n.activity));return o.transition(p).attr("opacity",1),o},a=>a.transition(d).attr("x",o=>(o.x0+o.x1)/2).attr("y",o=>(o.y0+o.y1)/2).text(o=>E(o.activity)).attr("opacity",1),a=>a.transition(c).attr("opacity",0).remove()).style("display",a=>{const n=E(a.activity).length*7,h=a.x1-a.x0,T=a.y1-a.y0;return h>=n&&T>14?"block":"none"})}catch(t){console.error("Render error:",t),R.value=t.message||"An unexpected error occurred."}finally{e===U&&(M.value=!1)}}function rt(e,t,i){if(!g.value)return;const r=!t.name&&t.target?t.target:t;B.value={name:r.name,path:r.path,value:r.activity,commit_per_day:(r.activity/(S.value*7)).toFixed(2)},g.value.style.display="block",O(e)}function O(e){if(!g.value||!C.value)return;const[t,i]=jt(e,C.value.parentElement),s=180;let r=t+20,l=i+20;r+s>f.value&&(r=t-s-20),g.value.style.left=`${r}px`,g.value.style.top=`${l}px`}function lt(){g.value&&(g.value.style.display="none")}let H;function K(){clearTimeout(H),H=setTimeout(()=>{G()},50)}return Mt(()=>j.query,e=>{let t=!1;const i=Array.isArray(e.repository)?e.repository[0]:e.repository;i&&i!==y.value&&(y.value=i,L.clear(),_.clear(),t=!0);const s=(Array.isArray(e.path)?e.path[0]:e.path)||".";s!==x.value&&(x.value=s,t=!0),t&&G()},{immediate:!0,deep:!0}),Bt(()=>{window.addEventListener("resize",K),G()}),Lt(()=>{window.removeEventListener("resize",K),clearTimeout(H)}),(e,t)=>{const i=At,s=St,r=I("b-breadcrumb-item"),l=I("b-breadcrumb"),d=I("b-slider"),p=I("b-field");return b(),w(ct,null,[u("div",Ft,[N(i),N(s,{size:"is-medium",modelValue:nt.value,"onUpdate:modelValue":t[0]||(t[0]=c=>nt.value=c),allowMultiple:!1,allowAll:!1,filter:vt},null,8,["modelValue"]),u("section",Pt,[u("div",Ut,[u("div",Gt,[u("div",Ot,[u("div",Ht,[t[4]||(t[4]=u("div",{class:"mr-5"},null,-1)),u("div",null,[N(l,{size:"is-medium",align:"is-left"},{default:Y(()=>[(b(!0),w(ct,null,Et(ot.value,(c,v)=>(b(),zt(r,{key:c.path,active:v===ot.value.length-1,tag:"a",onClick:k=>yt(c.path)},{default:Y(()=>[v===0?(b(),w("span",Kt,t[2]||(t[2]=[u("i",{class:"fas fa-code-branch"},null,-1)]))):Z("",!0),V(" "+$(c.label),1)]),_:2},1032,["active","onClick"]))),128))]),_:1}),t[3]||(t[3]=u("div",{class:"is-size-7 has-text-grey mt-1"}," *Displaying top active paths. ",-1))])])]),u("div",Xt,[u("div",Yt,[u("div",Zt," Includes: "+$(S.value*7)+" days. ",1),N(p,null,{default:Y(()=>[N(d,{modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=c=>S.value=c),min:1,max:300,step:1,size:"is-small",type:"is-info",onChange:K,tooltip:""},null,8,["modelValue"])]),_:1})])])]),M.value?(b(),w("div",Jt,t[5]||(t[5]=[u("span",{class:"icon mr-2"},[u("i",{class:"fas fa-spinner fa-spin"})],-1),V(" Loading data... Analyzing repository structure... ")]))):Z("",!0),R.value?(b(),w("div",Qt,$(R.value),1)):Z("",!0)])]),u("section",te,[(b(),w("svg",{ref_key:"svgRef",ref:C,width:f.value,height:F.value,class:"sankey-svg"},[u("g",{ref_key:"layerLinks",ref:tt},null,512),u("g",{ref_key:"layerNodes",ref:et},null,512),u("g",{ref_key:"layerLabels",ref:P},null,512)],8,ee)),u("div",{ref_key:"tooltipRef",ref:g,class:"chart-tooltip card",style:{display:"none",position:"absolute","pointer-events":"none","z-index":"100"}},[u("div",ne,[u("p",oe,$(B.value.name),1),u("div",ae,[u("p",se,[t[6]||(t[6]=V(" Commits: ")),u("strong",null,$(E(B.value.value)),1)]),u("p",null,[t[7]||(t[7]=V(" Commit/Days: ")),u("strong",null,$(B.value.commit_per_day),1)])])])],512)])]),t[8]||(t[8]=qt('<hr data-v-48eb2b48><section class="section" data-v-48eb2b48><div class="container content" data-v-48eb2b48><h2 class="title is-4" data-v-48eb2b48>README</h2><p data-v-48eb2b48> This visualization represents the number of commit in each file/directory. Note that a commit might affect multiple files, so the sum of all children nodes exceeds the parent&#39;s commit count. </p></div></section><section class="section" data-v-48eb2b48><div class="container content" data-v-48eb2b48><h2 class="title is-4" data-v-48eb2b48>Parameters</h2><ul data-v-48eb2b48><li data-v-48eb2b48><strong data-v-48eb2b48>Repository:</strong> The code repository being analyzed.</li><li data-v-48eb2b48><strong data-v-48eb2b48>Path:</strong> The current directory path in the repository.</li><li data-v-48eb2b48><strong data-v-48eb2b48>Smoothing Window:</strong> The number of days over which commit counts are smoothed to reduce noise.</li></ul></div></section>',3))],64)}}}),ge=Wt(ie,[["__scopeId","data-v-48eb2b48"]]);export{ge as default};
