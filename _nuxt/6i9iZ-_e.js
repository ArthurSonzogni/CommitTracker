import{_ as Me}from"./K_zvSPJA.js";import{_ as Te}from"./CH0ThVOt.js";import{f as Fe,h as v,y as Le,z as Ie,D as Re,G as qe,i as U,A as S,r as W,o as u,c as d,b as L,a as l,d as T,t as C,w as O,x as D,H as de,F as ve,k as fe,I as Ee,J as Ve,l as q,n as G}from"./BJdbIX9c.js";import{f as je}from"./D2nGpDRe.js";import{_ as Ne}from"./DlAUqK2U.js";import"./FOedhIC0.js";const Be={class:"container"},Pe={class:"level mb-4"},Ue={class:"level-left"},We={class:"breadcrumb has-succeeds-separator mb-0","aria-label":"breadcrumbs"},ze=["onClick"],He={class:"level-right"},Ye={class:"field has-addons mb-0"},Ke={class:"has-icons-left"},Oe={key:0,class:"control"},Ge={key:0,class:"notification"},Ze={key:1,class:"notification is-danger"},Je={key:2,class:"box p-0",style:{overflow:"hidden"}},Qe={class:"virtual-header columns is-mobile m-0 has-background-light has-text-weight-bold is-size-7-mobile"},Xe={key:0,class:"icon is-small ml-1"},et={key:0,class:"icon is-small ml-1"},tt={key:0,class:"icon is-small ml-1"},st={key:0,class:"icon is-small ml-1"},ot=["onClick"],lt={class:"column is-4 is-flex is-align-items-center is-clipped"},nt=["title"],at={class:"column is-2 is-flex is-align-items-center"},it={class:"column is-2 has-text-right is-family-monospace is-flex is-align-items-center is-justify-content-flex-end"},rt={class:"column is-2 has-text-right is-family-monospace is-flex is-align-items-center is-justify-content-flex-end"},ct={width:"150",height:"40",class:"sparkline"},ut=["d"],dt=["d"],vt={key:0,class:"has-text-centered p-6 has-text-grey"},ft={key:0},mt={key:1},Z="/commit_rates",me="2018-01-01",z=50,he=10,ht=Fe({__name:"commit-rates",setup(pt){const x=v(["chromium"]),g=v("."),J=v([]),$=v([]),H=v(!1),V=v(null),p=v(40),f=v("name"),w=v(!1),I=v(!1),y=v(""),j=v(null),E=v(null),Q=v(0),X=v(600),_=Le(),pe=Ie();Re(()=>{E.value&&(X.value=E.value.clientHeight),window.addEventListener("keydown",te)}),qe(()=>{window.removeEventListener("keydown",te)});const ee=()=>{if(_.query.repository){const e=Array.isArray(_.query.repository)?_.query.repository[0]:_.query.repository;x.value=[e]}if(g.value=_.query.path||".",_.query.smoothing){const e=parseInt(_.query.smoothing,10);!isNaN(e)&&e>=1&&e<=52?p.value=e:p.value=40}else p.value=40;I.value=_.query.showDeleted==="true",y.value=_.query.search||"";const t=_.query.sortBy;["name","total","window","score"].includes(t)?f.value=t:f.value="name",w.value=_.query.sortDesc==="true"};ee(),U(_,ee);function te(t){if((t.ctrlKey||t.metaKey)&&(t.key==="f"||t.key==="F"||t.code==="KeyF")&&(t.preventDefault(),j.value&&(j.value.focus(),j.value.select())),t.key==="Enter"&&y.value&&(A.value.length==1||A.value.length>1&&A.value[0].name.toLowerCase()===y.value.toLowerCase())){const e=A.value[0];re(e);return}}const ye=je(",");function se(t){return ye(t)}function ge(t){return t>=.5?"is-success":t>=.1?"is-warning":"is-danger"}const we=S(()=>new Date(me).getFullYear()),N=S(()=>{const t=new Date(me),n=Math.abs(new Date().getTime()-t.getTime());return Math.floor(Math.ceil(n/(1e3*60*60*24))/7)}),oe=S(()=>{if(p.value>=52)return N.value;const t=Math.max(52,p.value*5);return Math.min(N.value,t)}),_e=S(()=>{const t=oe.value;if(t>=N.value-1)return`Since ${we.value}`;if(t>=52){const e=(t/52).toFixed(1).replace(".0","");return`${e} Year${e==="1"?"":"s"}`}return`${t} Weeks`}),le=S(()=>{if(g.value==="."||g.value==="")return[];const t=g.value.split("/");return t.map((e,n)=>({name:e,fullPath:t.slice(0,n+1).join("/")}))}),ke=S(()=>{const t=N.value,e=p.value||4,n=Math.pow(.5,1/e);let o=[];if($.value.length>0){let a=[...$.value];a.length<t&&(a=a.concat(new Array(t-a.length).fill(0))),o=ne(a,e)}const i=J.value.map(a=>{let s=a.rates;if(s.length<t){const b=t-s.length,R=new Array(b).fill(0);s=s.concat(R)}let m=0;for(let b=0;b<s.length;b++){const R=s[s.length-1-b],K=Math.pow(n,b);m+=R*K}const h=ne(s,e),M=h[h.length-1]||0,F=Math.max(...h,1),k=M/F;return{...a,rates:s,weightedSum:m,smoothed:h,currentActivity:M,peakScore:k}}),r=i.reduce((a,s)=>a+s.weightedSum,0),c=i.map(a=>{const s=r>0?a.weightedSum/r:0;let m=0;if(o.length>0){let k=0;const b=Math.min(a.smoothed.length,o.length);for(let P=0;P<b;P++){const ce=o[P],Ae=a.smoothed[P],ue=ce>0?Ae/ce:0;ue>k&&(k=ue)}const R=o[o.length-1]||0,K=R>0?a.currentActivity/R:0;m=k>0?K/k:0}const h=[s,a.peakScore,m],M=.7*Math.max(...h)+.3*(h.reduce((k,b)=>k+b,0)/h.length),F=a.rates.reduce((k,b)=>k+b,0);return{...a,smoothedRates:a.smoothed,totalCommits:F,windowCommits:a.currentActivity,activityScore:parseFloat(M.toFixed(3))}});return I.value?c:c.filter(a=>!a.isDeleted)}),A=S(()=>{let t=[...ke.value];if(y.value){const e=y.value.toLowerCase();t=t.filter(n=>n.name.toLowerCase().includes(e))}return t.sort((e,n)=>{if(e.isDirectory!==n.isDirectory)return e.isDirectory?-1:1;let o,i;return f.value==="name"?(o=e.name.toLowerCase(),i=n.name.toLowerCase()):f.value==="total"?(o=e.totalCommits,i=n.totalCommits):f.value==="window"?(o=e.windowCommits,i=n.windowCommits):f.value==="score"&&(o=e.activityScore,i=n.activityScore),o<i?w.value?1:-1:o>i?w.value?-1:1:0})}),be=S(()=>A.value.length*z),xe=S(()=>{const t=A.value.length;if(t===0)return[];const e=Math.floor(Q.value/z)-he,n=Math.max(0,e),o=Math.ceil(X.value/z)+2*he,i=Math.min(t,n+o),r=[];for(let c=n;c<i;c++){const a=A.value[c];r.push({...a,offset:c*z})}return r});function Ce(t){Q.value=t.target.scrollTop}function B(t){f.value===t?w.value=!w.value:(f.value=t,w.value=t!=="name")}function ne(t,e){if(e<=1)return t;const n=[];let o=0;for(let i=0;i<t.length;i++)o+=t[i],i>=e&&(o-=t[i-e]),n.push(o);return n}function De(t){let e=5381;for(let o=0;o<t.length;o++){const i=t.charCodeAt(o);e=(e<<5)+e^i,e=e|0}return(e>>>0)%2048}function ae(t){if(!t||t.length===0)return[];let e=0;for(let o=0;o<t.length;o+=2){const i=t[o],r=t[o+1],c=i+r.length;c>e&&(e=c)}const n=new Array(e).fill(0);for(let o=0;o<t.length;o+=2){const i=t[o],r=t[o+1];for(let c=0;c<r.length;c++)n[i+c]=r[c]}return n}function ie(t,e=!1){if(!t.length)return"";const n=oe.value,o=t.slice(-n),i=150,r=40,c=Math.max(...o,1),a=i/(o.length-1||1),m=`M ${o.map((h,M)=>{const F=M*a,k=r-h/c*r;return`${F},${k}`}).join(" L ")}`;return e?`${m} L ${i},${r} L 0,${r} Z`:m}async function Se(t){try{const e=`${Z}/${t}/total.json`,n=await fetch(e);if(!n.ok){$.value=[];return}const o=await n.json();Array.isArray(o)?$.value=o:o.r?$.value=ae(o.r):o.total&&Array.isArray(o.total)?$.value=o.total:$.value=[]}catch(e){console.warn("Failed to load total.json",e),$.value=[]}}async function $e(t,e){E.value&&(E.value.scrollTop=0);try{let n="";if(e===".")n=`${Z}/${t}/main.json`;else{const a=De(e);console.log("Fetching bucket:",a,"for path:",e),n=`${Z}/${t}/${a}.json`}const o=await fetch(n);if(!o.ok)throw o.status===404?new Error("Path not found in data."):new Error("Failed to load data.");const r=(await o.json())[e];if(!r)throw new Error(`Directory data missing for path: ${e}`);const c=Object.entries(r).map(([a,s])=>{const m=s.r,h=typeof s.d=="number"?s.d:null,M=h!==null,F=s.f==null||s.f!=1;return{name:a,rates:ae(m),isDirectory:F,isDeleted:M,deletedAt:h}});H.value=!0,V.value=null,J.value=c}catch(n){console.error(n),V.value=n.message}finally{H.value=!1}}function Y(t){history.pushState(null,"",window.location.href),y.value="",g.value=t}function re(t){if(!t.isDirectory)return;const e=g.value==="."?t.name:`${g.value}/${t.name}`;Y(e)}return U(x,()=>{const t=x.value[0];t&&Se(t)},{immediate:!0}),U([x,g],()=>{const t=x.value[0];t&&$e(t,g.value)},{immediate:!0}),U([x,g,p,I,y,f,w],()=>{const t=x.value[0];pe.replace({query:{repository:t,path:g.value,smoothing:p.value.toString(),showDeleted:I.value.toString(),search:y.value,sortBy:f.value,sortDesc:w.value.toString()}})}),(t,e)=>{const n=Me,o=Te,i=W("b-slider"),r=W("b-field"),c=W("b-checkbox"),a=W("b-progress");return u(),d("div",null,[L(n),L(o,{class:"ml-4 mr-4",size:"is-medium",modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=s=>x.value=s),allowMultiple:!1,allowAll:!1,filter:s=>!s.cone},null,8,["modelValue","filter"]),l("div",Be,[l("div",null,[e[11]||(e[11]=T(" Smoothing Window: ")),l("strong",null,C(p.value)+" week"+C(p.value===1?"":"s"),1),e[12]||(e[12]=T(", displaying activity over ")),l("strong",null,C(_e.value),1),e[13]||(e[13]=T(". ")),L(r,null,{default:O(()=>[L(i,{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=s=>p.value=s),min:1,max:52,step:1,size:"is-medium",type:"is-info"},null,8,["modelValue"])]),_:1}),L(r,null,{default:O(()=>[L(c,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=s=>I.value=s)},{default:O(()=>e[10]||(e[10]=[T(" Show deleted files ")])),_:1},8,["modelValue"])]),_:1})]),l("div",Pe,[l("div",Ue,[l("nav",We,[l("ul",null,[l("li",{class:D({"is-active":g.value==="."})},[l("a",{onClick:e[3]||(e[3]=de(s=>Y("."),["prevent"]))},C(x.value[0]),1)],2),(u(!0),d(ve,null,fe(le.value,(s,m)=>(u(),d("li",{key:m,class:D({"is-active":m===le.value.length-1})},[l("a",{onClick:de(h=>Y(s.fullPath),["prevent"])},C(s.name),9,ze)],2))),128))])])]),l("div",He,[l("div",Ye,[l("div",Ke,[Ee(l("input",{ref_key:"searchInput",ref:j,class:"input",type:"text",placeholder:"Find in this folder...","onUpdate:modelValue":e[4]||(e[4]=s=>y.value=s)},null,512),[[Ve,y.value]]),e[14]||(e[14]=l("span",{class:"icon is-small is-left"},[l("i",{class:"fas fa-search"})],-1))]),y.value?(u(),d("div",Oe,[l("button",{class:"button",onClick:e[5]||(e[5]=s=>y.value="")},e[15]||(e[15]=[l("span",{class:"icon is-small"},[l("i",{class:"fas fa-times"})],-1)]))])):q("",!0)])])]),H.value?(u(),d("div",Ge,"Loading data...")):V.value?(u(),d("div",Ze,C(V.value),1)):(u(),d("div",Je,[l("div",Qe,[l("div",{class:"column is-4 is-clickable select-none",onClick:e[6]||(e[6]=s=>B("name"))},[e[16]||(e[16]=T(" File / Directory ")),f.value==="name"?(u(),d("span",Xe,[l("i",{class:D(w.value?"fas fa-angle-down":"fas fa-angle-up")},null,2)])):q("",!0)]),l("div",{class:"column is-2 is-clickable select-none",onClick:e[7]||(e[7]=s=>B("score"))},[e[17]||(e[17]=T(" Liveness ")),f.value==="score"?(u(),d("span",et,[l("i",{class:D(w.value?"fas fa-angle-down":"fas fa-angle-up")},null,2)])):q("",!0)]),l("div",{class:"column is-2 has-text-right is-clickable select-none",onClick:e[8]||(e[8]=s=>B("total"))},[e[18]||(e[18]=T(" Total ")),f.value==="total"?(u(),d("span",tt,[l("i",{class:D(w.value?"fas fa-angle-down":"fas fa-angle-up")},null,2)])):q("",!0)]),l("div",{class:"column is-2 has-text-right is-clickable select-none",onClick:e[9]||(e[9]=s=>B("window"))},[T(" Last "+C(p.value)+"w ",1),f.value==="window"?(u(),d("span",st,[l("i",{class:D(w.value?"fas fa-angle-down":"fas fa-angle-up")},null,2)])):q("",!0)]),e[19]||(e[19]=l("div",{class:"column is-2"}," Activity ",-1))]),l("div",{class:"virtual-scroll-container",ref_key:"scrollContainer",ref:E,onScroll:Ce},[l("div",{style:G({height:be.value+"px"})},null,4),(u(!0),d(ve,null,fe(xe.value,s=>(u(),d("div",{key:s.name,class:D(["virtual-row columns is-mobile m-0",{"has-text-grey-light":s.isDeleted,"is-clickable":s.isDirectory}]),style:G({transform:`translateY(${s.offset}px)`}),onClick:m=>re(s)},[l("div",lt,[l("span",{class:D(["icon is-small is-left mr-2",s.isDeleted?"has-text-grey-lighter":"has-text-grey"])},[l("i",{class:D(s.isDirectory?"fas fa-folder":"fas fa-file")},null,2)],2),l("span",{class:D(["is-clipped",{"has-text-weight-bold":s.isDirectory,"is-deleted-name":s.isDeleted}]),title:s.name+(s.isDeleted?" (Deleted)":"")},C(s.name),11,nt)]),l("div",at,[L(a,{value:5+s.activityScore*95,type:ge(s.activityScore),size:"is-small",style:{width:"100%","margin-bottom":"0",opacity:"0.8"}},null,8,["value","type"])]),l("div",it,C(se(s.totalCommits)),1),l("div",rt,C(se(s.windowCommits)),1),l("div",{class:"column is-2 p-0 is-flex is-align-items-center",style:G({opacity:s.isDeleted?.4:1})},[(u(),d("svg",ct,[l("path",{d:ie(s.smoothedRates),fill:"none",stroke:"#3e8ed0","stroke-width":"2"},null,8,ut),l("path",{d:ie(s.smoothedRates,!0),fill:"#3e8ed0","fill-opacity":"0.1",stroke:"none"},null,8,dt)]))],4)],14,ot))),128)),A.value.length===0?(u(),d("div",vt,[y.value?(u(),d("span",ft,"No matching files found.")):(u(),d("span",mt,"Empty directory or no data found."))])):q("",!0)],544)]))])])}}}),xt=Ne(ht,[["__scopeId","data-v-07f24479"]]);export{xt as default};
