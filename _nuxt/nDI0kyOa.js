import{_ as Wt}from"./DkkWKaWJ.js";import{s as F,t as ft,c as ht}from"./DkrfxnvH.js";import{f as Xt,S as Yt,h as E,s as Rt,A as Zt,i as pt,D as Gt,o as mt,c as At,a as D,t as _t,j as Y,p as Kt,l as Qt,a8 as te,a9 as ee}from"./BJdbIX9c.js";import{f as gt}from"./D2nGpDRe.js";import{l as O}from"./E4HCz5LM.js";import{l as ne}from"./ntdiYfc-.js";function oe(t){var r=0,u=t.children,d=u&&u.length;if(!d)r=1;else for(;--d>=0;)r+=u[d].value;t.value=r}function ie(){return this.eachAfter(oe)}function re(t,r){let u=-1;for(const d of this)t.call(r,d,++u,this);return this}function ae(t,r){for(var u=this,d=[u],p,_,h=-1;u=d.pop();)if(t.call(r,u,++h,this),p=u.children)for(_=p.length-1;_>=0;--_)d.push(p[_]);return this}function ce(t,r){for(var u=this,d=[u],p=[],_,h,w,b=-1;u=d.pop();)if(p.push(u),_=u.children)for(h=0,w=_.length;h<w;++h)d.push(_[h]);for(;u=p.pop();)t.call(r,u,++b,this);return this}function se(t,r){let u=-1;for(const d of this)if(t.call(r,d,++u,this))return d}function le(t){return this.eachAfter(function(r){for(var u=+t(r.data)||0,d=r.children,p=d&&d.length;--p>=0;)u+=d[p].value;r.value=u})}function ue(t){return this.eachBefore(function(r){r.children&&r.children.sort(t)})}function de(t){for(var r=this,u=fe(r,t),d=[r];r!==u;)r=r.parent,d.push(r);for(var p=d.length;t!==u;)d.splice(p,0,t),t=t.parent;return d}function fe(t,r){if(t===r)return t;var u=t.ancestors(),d=r.ancestors(),p=null;for(t=u.pop(),r=d.pop();t===r;)p=t,t=u.pop(),r=d.pop();return p}function he(){for(var t=this,r=[t];t=t.parent;)r.push(t);return r}function pe(){return Array.from(this)}function me(){var t=[];return this.eachBefore(function(r){r.children||t.push(r)}),t}function _e(){var t=this,r=[];return t.each(function(u){u!==t&&r.push({source:u.parent,target:u})}),r}function*ge(){var t=this,r,u=[t],d,p,_;do for(r=u.reverse(),u=[];t=r.pop();)if(yield t,d=t.children)for(p=0,_=d.length;p<_;++p)u.push(d[p]);while(u.length)}function vt(t,r){t instanceof Map?(t=[void 0,t],r===void 0&&(r=xe)):r===void 0&&(r=ye);for(var u=new et(t),d,p=[u],_,h,w,b;d=p.pop();)if((h=r(d.data))&&(b=(h=Array.from(h)).length))for(d.children=h,w=b-1;w>=0;--w)p.push(_=h[w]=new et(h[w])),_.parent=d,_.depth=d.depth+1;return u.eachBefore(ze)}function ve(){return vt(this).eachBefore(we)}function ye(t){return t.children}function xe(t){return Array.isArray(t)?t[1]:null}function we(t){t.data.value!==void 0&&(t.value=t.data.value),t.data=t.data.data}function ze(t){var r=0;do t.height=r;while((t=t.parent)&&t.height<++r)}function et(t){this.data=t,this.depth=this.height=0,this.parent=null}et.prototype=vt.prototype={constructor:et,count:ie,each:re,eachAfter:ce,eachBefore:ae,find:se,sum:le,sort:ue,path:de,ancestors:he,descendants:pe,leaves:me,links:_e,copy:ve,[Symbol.iterator]:ge};function be(t){if(typeof t!="function")throw new Error;return t}function Z(){return 0}function G(t){return function(){return t}}function je(t){t.x0=Math.round(t.x0),t.y0=Math.round(t.y0),t.x1=Math.round(t.x1),t.y1=Math.round(t.y1)}function Me(t,r,u,d,p){for(var _=t.children,h,w=-1,b=_.length,R=t.value&&(d-r)/t.value;++w<b;)h=_[w],h.y0=u,h.y1=p,h.x0=r,h.x1=r+=h.value*R}function Be(t,r,u,d,p){for(var _=t.children,h,w=-1,b=_.length,R=t.value&&(p-u)/t.value;++w<b;)h=_[w],h.x0=r,h.x1=d,h.y0=u,h.y1=u+=h.value*R}var ke=(1+Math.sqrt(5))/2;function Re(t,r,u,d,p,_){for(var h=[],w=r.children,b,R,v=0,k=0,i=w.length,M,B,j=r.value,y,x,I,J,L,q,C;v<i;){M=p-u,B=_-d;do y=w[k++].value;while(!y&&k<i);for(x=I=y,q=Math.max(B/M,M/B)/(j*t),C=y*y*q,L=Math.max(I/C,C/x);k<i;++k){if(y+=R=w[k].value,R<x&&(x=R),R>I&&(I=R),C=y*y*q,J=Math.max(I/C,C/x),J>L){y-=R;break}L=J}h.push(b={value:y,dice:M<B,children:w.slice(v,k)}),b.dice?Me(b,u,d,p,j?d+=B*y/j:_):Be(b,u,d,j?u+=M*y/j:p,_),j-=y,v=k}return h}const $t=function t(r){function u(d,p,_,h,w){Re(r,d,p,_,h,w)}return u.ratio=function(d){return t((d=+d)>1?d:1)},u}(ke);function Ae(){var t=$t,r=!1,u=1,d=1,p=[0],_=Z,h=Z,w=Z,b=Z,R=Z;function v(i){return i.x0=i.y0=0,i.x1=u,i.y1=d,i.eachBefore(k),p=[0],r&&i.eachBefore(je),i}function k(i){var M=p[i.depth],B=i.x0+M,j=i.y0+M,y=i.x1-M,x=i.y1-M;y<B&&(B=y=(B+y)/2),x<j&&(j=x=(j+x)/2),i.x0=B,i.y0=j,i.x1=y,i.y1=x,i.children&&(M=p[i.depth+1]=_(i)/2,B+=R(i)-M,j+=h(i)-M,y-=w(i)-M,x-=b(i)-M,y<B&&(B=y=(B+y)/2),x<j&&(j=x=(j+x)/2),t(i,B,j,y,x))}return v.round=function(i){return arguments.length?(r=!!i,v):r},v.size=function(i){return arguments.length?(u=+i[0],d=+i[1],v):[u,d]},v.tile=function(i){return arguments.length?(t=be(i),v):t},v.padding=function(i){return arguments.length?v.paddingInner(i).paddingOuter(i):v.paddingInner()},v.paddingInner=function(i){return arguments.length?(_=typeof i=="function"?i:G(+i),v):_},v.paddingOuter=function(i){return arguments.length?v.paddingTop(i).paddingRight(i).paddingBottom(i).paddingLeft(i):v.paddingTop()},v.paddingTop=function(i){return arguments.length?(h=typeof i=="function"?i:G(+i),v):h},v.paddingRight=function(i){return arguments.length?(w=typeof i=="function"?i:G(+i),v):w},v.paddingBottom=function(i){return arguments.length?(b=typeof i=="function"?i:G(+i),v):b},v.paddingLeft=function(i){return arguments.length?(R=typeof i=="function"?i:G(+i),v):R},v}const $e={class:"component-container"},Ce={class:"section",style:{"padding-top":"0"}},De={class:"split-view"},Se={width:"100%",height:"100%"},qe=Xt({__name:"Treemap",props:{repositories:{type:Array[String],default:()=>["chromium"]},path:{},field_color:{},field_size:{},colormap:{},colormapMin:{},colormapMax:{},dates:{},animate:{type:Boolean,default:!1},history_color:{type:Boolean,default:!0},history_size:{type:Boolean,default:!1},exclude_test:{type:Boolean,default:!1},exclude_third_party:{type:Boolean,default:!1}},emits:["zoomin","animationend"],setup(t,{expose:r,emit:u}){const{$color_map:d}=Yt(),p=E(null),_=E(null),h=E(null);E(null);const w=E("Tooltip"),b=E("."),R=E("..");let v,k=[],i={},M={},B={},j={},y={},x={};const I=Rt({});let J=-1;const L=Rt([]);let q=d[0];const C=gt(",d"),Ct=gt(".1%"),s=t,yt=u;function K(o,e,c){const a=document.createElement("a"),n=new Blob([o],{type:c});a.href=URL.createObjectURL(n),a.download=e,a.click()}function Dt(o){if(console.log("Download",o),o=="temporal_json"){const e=[].concat(s.field_size).concat(s.field_color),c=[];for(const a of e)c.push({metric:a,values:ot(a).map((n,l)=>({date:nt(l),count:n}))});K(JSON.stringify(c,null,2),"temporal.json","application/json");return}if(o=="temporal_csv"){const e=[].concat(s.field_size).concat(s.field_color);let c="date,"+e.join(",")+`
`;for(let a=0;a<k.length;++a){const n=[nt(a).toISOString().split("T")[0]];for(const l of e){const g=ot(l);n.push(g[a])}c+=n.join(",")+`
`}K(c,"temporal.csv","text/csv");return}if(o=="spatial_json"){const e=[].concat(s.field_size).concat(s.field_color),c=n=>{const l={};for(const f of e)l[f]=x[f][n.id]||0;let g=!0;for(const f of e)if(l[f]!=0){g=!1;break}if(g)return null;l.children={};for(const f of n.children||[]){const m=c(f);m&&(l.children[f.name]=m)}return Object.keys(l.children).length==0&&delete l.children,l},a=c(P(s.path).data);K(JSON.stringify(a,null,2),"spatial.json","application/json");return}if(o=="spatial_csv"){const e=[].concat(s.field_size).concat(s.field_color);let c="path,"+e.join(",")+`
`;const a=(n,l)=>{const g=[l.join("/")||"/"];let f=!0;for(const m of e){const z=x[m][n.id]||0;g.push(z),z!=0&&(f=!1)}f||(c+=g.join(",")+`
`);for(const m of n.children||[])a(m,l.concat([m.name]))};a(P(s.path).data,s.path),K(c,"spatial.csv","text/csv");return}}r({download:Dt});const xt=()=>s.exclude_test&&s.exclude_third_party?j:s.exclude_test?M:s.exclude_third_party?B:i,St=(o,e)=>{let c=0;for(const[a,n]of y[o][e]||[]){if(a<=J){c=n;continue}break}return c},U=()=>{var o;return(o=p.value)==null?void 0:o.clientWidth},W=()=>{var o;return(o=p.value)==null?void 0:o.clientHeight},wt=function(o,e,c){return o.attr("transform",a=>`translate(${e(a.x0)}, ${c(a.y0)})`)},Q=function(o,e,c,a){return o.attr("rx",10).attr("stroke","white").attr("stroke-width",5).attr("fill-opacity",.9).attr("width",n=>e(n.x1)-e(n.x0)).attr("height",n=>c(n.y1)-c(n.y0)).style("fill",n=>{const l=O().domain([s.colormapMin||0,s.colormapMax||1]).range([0,1]),g=n.data.color,f=n.data.area,m="gray",z=q(l(g/f));return te(m,z)(a?.5:.9)})},zt=function(o,e){return o.attr("text-anchor","start").attr("alignment-baseline","middle").attr("x",8).attr("opacity",.5-e*.2).style("font-weight",e==0?"bold":"normal")},tt=function(o,e,c){const a=O().domain([s.colormapMin||0,s.colormapMax||1]).range([0,1]),n=l=>{const g=c.data.area,f=l.data.area;if(g==0)return 0;const m=f/g*10;return m<.02?0:Math.min(20,Math.sqrt(m)*30)};o.style("fill",l=>{const g=l.data.color,f=l.data.area,m=q(a(g/f));return ee(m).l<.5?"white":"black"}).style("font-size",l=>n(l)*(4-e)*.25).attr("y",l=>5+n(l)*(e+1)*1.2).text(l=>{if(e==0)return`${l.data.name}`;{const g=l.data.color,f=l.data.area;if(g<=f)return`${C(g)}/${C(f)} (${Ct(g/f)})`;{const m=(g/f).toFixed(1);return`${C(g)}/${C(f)} (${m}x)`}}})},X=function(o,e,c,a,n=!1,l){const g=m=>m.join(z=>{const $=z.append("g"),A=$.append("rect"),S=$.append("text").classed("text-1",!0),V=$.append("text").classed("text-2",!0);return wt($,c,a),Q(A,c,a,!1),zt(S,0),zt(V,1),tt(S,0,e),tt(V,1,e),$},z=>{const $=z.transition(l),A=$.select("rect");wt($,c,a),Q(A,c,a,!1);const S=$.select("text.text-1"),V=$.select("text.text-2");return tt(S,0,e),tt(V,1,e),z},z=>z.remove());if(!e.children){o.selectAll("g").remove();const m=U(),z=W();o.selectAll("text").data([0],A=>A).join(A=>{const S=A.append("text");return S.classed("no-data",!0).attr("text-anchor","middle").attr("alignment-baseline","middle").attr("x",m/2).attr("y",z/2).style("font-size",20).style("font-weight","bold").style("fill","gray").text("Zero data recorded at this directory and date"),S},A=>A,A=>A.remove());return}o.selectAll("text.no-data").remove();const f=g(o.selectAll("g").data(e.children,m=>m.data.name));f.filter(m=>m.children).attr("cursor","pointer").on("click",(m,z)=>Ft(z)),f.on("mousemove",(m,z)=>{const $=F(m.currentTarget).select("rect");Q($,c,a,!0),w.value=z.data.name,b.value=z.data.name,R.value=e.data.name,F(h.value).style("opacity",1),p.value.getBoundingClientRect();const A=_.value.getBoundingClientRect(),S=h.value.getBoundingClientRect(),V=A.right-S.width,Bt=A.bottom-S.height;let rt=Math.min(m.clientX+20,V),at=Math.min(m.clientY+20,Bt);rt==V&&at==Bt&&(rt=m.clientX-S.width-20,at=m.clientY-S.height-20),F(h.value).style("left",rt-A.left+"px").style("top",at-A.top+"px");const Pt=[].concat(s.field_size).concat(s.field_color),kt=N=>{const H=N.select("td.v1"),ct=N.select("td.v2"),st=N.select("td.v3"),lt=N.select("td.v4");return H.text(T=>T),ct.text(T=>C(x[T][e.data.id]||0)),st.text(T=>C(x[T][z.data.id]||0)),lt.text(T=>{const ut=x[T][z.data.id]||0,dt=x[T][e.data.id]||0;return ut>dt?`${(ut/dt).toFixed(1)}x`:`${Math.floor(100*ut/dt)}%`}),N};F(h.value).select("tbody").selectAll("tr").data(Pt).join(N=>{const H=N.append("tr"),ct=H.append("td"),st=H.append("td"),lt=H.append("td"),T=H.append("td");return ct.attr("class","v1"),st.attr("class","v2"),lt.attr("class","v3"),T.attr("class","v4"),kt(H)},kt,N=>N.remove())}).on("mouseleave",(m,z)=>{const $=F(m.currentTarget).select("rect");Q($,c,a,!1),F(h.value).style("opacity",0)})},Ft=function(o){yt("zoomin",o.data.name)},Tt=async function(o,e){const c=ft().duration(0).ease(ht),a=ft().duration(500).ease(ht),n=F(_.value).select("g"),l=F(_.value).append("g");{const f=O().domain([o.x0,o.x1]).rangeRound([0,U()-20]),m=O().domain([o.y0,o.y1]).rangeRound([0,W()-20]);X(n,o,f,m,!0,c),X(l,e,f,m,!0,c)}{const f=O().domain([e.x0,e.x1]).rangeRound([0,U()-20]),m=O().domain([e.y0,e.y1]).rangeRound([0,W()-20]);X(n,o,f,m,!0,a),X(l,e,f,m,!0,a)}n.attr("opacity",1).transition(a).attr("opacity",0),l.attr("opacity",0).transition(a).attr("opacity",1),n.transition(a).remove();const g=a.end();bt(),await g},Nt=function(o){const e=vt(o).each(n=>n.value=n.data.area).sort((n,l)=>l.value-n.value);return Ae().tile($t).size([U()*.8,W()]).round(!0)(e).sort((n,l)=>l.height-n.height)},It=o=>{let e=0,c=1/0;for(let a=0;a<k.length;++a){const n=Math.abs(k[a]-o);n<c&&(c=n,e=a)}return e},nt=o=>k[o],ot=o=>{const e=new Array(k.length).fill(0),c=a=>{for(const f of a.children||[])c(f);const n=y[o][a.id];if(!n)return;let l=0,g=0;for(let f=0;f<k.length;++f){for(;g<n.length&&n[g][0]<=f;)l=n[g][1],g+=1;e[f]+=l}};return c(P(s.path).data),e},bt=()=>{let o=[];if(s.field_size.length==0)o=s.field_color;else if(s.field_color.length==0)o=s.field_size;else if(s.history_color&&s.history_size)o=[].concat(s.field_size).concat(s.field_color);else if(s.history_color)o=s.field_color;else if(s.history_size)o=s.field_size;else{L.value=[];return}const e=[];for(const c of o){const a=ot(c);e.push({label:c,extra_label:" = "+gt(",d")(a.at(-1)),values:a.map((n,l)=>({x:nt(l),y:n})).filter(n=>n.x>=s.dates[0]&&n.x<=s.dates[1])})}L.value=e};async function Lt(){if(k.length)return;k=(await(await fetch(`/treemap/${s.repositories[0]}/dates.json`)).json()).map(c=>new Date(c))}async function Ot(){if(i.name)return;i=await(await fetch(`/treemap/${s.repositories[0]}/file_index.json`)).json();const e=(n,l)=>{const g=l.toLowerCase();return g.includes("test")||g.includes("mock")||g.includes("example")},c=(n,l)=>{const g=n.toLowerCase(),f=l.toLowerCase();return g=="root"&&f=="third_party"?!1:g=="third_party"?f!="blink":!1},a=(n,l,g)=>{if(l(g,n.name))return null;const f={name:n.name,id:n.id};if(!n.children)return f;f.children=[];for(const m of n.children){const z=a(m,l,n.name);z&&f.children.push(z)}return f.children.length==0&&delete f.children,f};M=a(i,e,"root"),B=a(i,c,"root"),j=a(i,(n,l)=>e(n,l)||c(n,l),"root"),console.log("file_index",i),console.log("file_index_excluding_test",M),console.log("file_index_excluding_third_party",B),console.log("file_index_excluding_test_and_third_party",j)}async function qt(){const o=[].concat(s.field_size).concat(s.field_color);for(const e of o){if(y[e])continue;const c=await fetch(`/treemap/${s.repositories[0]}/metrics/${e}.json`);y[e]=await c.json()}}function Vt(){for(const o in y){x[o]={};for(const c in y[o])x[o][c]=St(o,c);const e=c=>{var a,n;if((a=x[o])[n=c.id]||(a[n]=0),!!c.children)for(const l of c.children)e(l),x[o][c.id]+=x[o][l.id]};e(xt())}}function Ht(){const o=structuredClone(xt()),e=s.field_size.length?s.field_size:s.field_color,c=s.field_color.length?s.field_color:s.field_size,a=n=>{for(const l of n.children||[])a(l);n.area=0,n.color=0;for(const l of e)n.area+=x[l][n.id];for(const l of c)n.color+=x[l][n.id]};a(o),v=o}async function jt(){await Promise.all([Lt(),Ot(),qt()]),J=It(s.dates[1]),Vt(),Ht()}const P=function(o){let e=I.value;for(const c of o)for(let a of e.children)if(a.data.name==c){e=a;break}return e};async function Mt(){q=d[s.colormap],F(_.value).select("g").node()||F(_.value).append("g");const o=P(s.path),e=F(_.value).select("g"),c=O().domain([o.x0,o.x1]).rangeRound([0,U()-20]),a=O().domain([o.y0,o.y1]).rangeRound([0,W()-20]),n=ft().duration(300).ease(s.animate?ht:ne);X(e,o,c,a,!1,n),await n.end(),bt(),yt("animationend")}async function it(){I.value=Nt(v),await Mt()}const Et=async function(o,e){const c=P(e),a=P(o);await Tt(c,a)},Jt=Zt(()=>[...s.path]);return pt(()=>[s.repositories,s.field_size,s.field_color,s.dates,s.history_color,s.exclude_test,s.exclude_third_party,s.history_size],async()=>{await jt(),await it()}),pt(()=>[s.colormap,s.colormapMin,s.colormapMax],Mt),pt(Jt,Et),Gt(async()=>{await jt(),await it(),new ResizeObserver(it).observe(p.value)}),(o,e)=>{const c=Wt;return mt(),At("div",$e,[D("div",Ce,[D("div",De,[D("div",{ref_key:"container",ref:p,class:"treemap-container"},[D("table",{class:"treemap-tooltip",ref_key:"tooltip",ref:h},[D("thead",null,[D("tr",null,[D("td",null,_t(Y(w)),1),D("td",null,_t(Y(R)),1),D("td",null,_t(Y(b)),1),e[0]||(e[0]=D("td",null," % ",-1))])]),e[1]||(e[1]=D("tbody",null,null,-1))],512),(mt(),At("svg",Se,[D("g",{ref_key:"content",ref:_},null,512)]))],512),D("div",null,[Y(L)?(mt(),Kt(c,{key:0,data:Y(L)},null,8,["data"])):Qt("",!0)])])])])}}});export{qe as _};
