name: importer

on:
  workflow_dispatch:
    inputs:
      run_commits:
        description: 'Fetch Commits & Update Data'
        type: boolean
        default: true
      run_treemap:
        description: 'Generate Treemap'
        type: boolean
        default: true
      run_fuzz:
        description: 'Fetch Fuzz Data'
        type: boolean
        default: true
      run_cve:
        description: 'Fetch CVE Data'
        type: boolean
        default: true
      run_graph:
        description: 'Generate C++ Graphs'
        type: boolean
        default: true
  schedule:
    - cron: '0 0 * * 1,2,3,4,5'

jobs:
  importer:
    runs-on: ubuntu-latest

    steps:
      - name: Configure Run Flags
        id: config
        run: |
          # Default: Assume we do not run anything unless specified
          DO_COMMITS="false"
          DO_TREEMAP="false"
          DO_FUZZ="false"
          DO_CVE="false"
          DO_GRAPH="false"

          # Logic for Scheduled Runs (Cron)
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            # Commits run every day
            DO_COMMITS="true"

            DAY_OF_WEEK=$(date +%u)

            if [[ "$DAY_OF_WEEK" == "1" ]]; then DO_TREEMAP="true"; fi
            if [[ "$DAY_OF_WEEK" == "2" ]]; then DO_FUZZ="true"; fi
            if [[ "$DAY_OF_WEEK" == "4" ]]; then DO_CVE="true"; fi
            if [[ "$DAY_OF_WEEK" == "5" ]]; then DO_GRAPH="true"; fi
          fi

          # Logic for Manual Runs
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DO_COMMITS="${{ inputs.run_commits }}"
            DO_TREEMAP="${{ inputs.run_treemap }}"
            DO_FUZZ="${{ inputs.run_fuzz }}"
            DO_CVE="${{ inputs.run_cve }}"
            DO_GRAPH="${{ inputs.run_graph }}"
          fi

          echo "run_commits=$DO_COMMITS" >> $GITHUB_OUTPUT
          echo "run_treemap=$DO_TREEMAP" >> $GITHUB_OUTPUT
          echo "run_fuzz=$DO_FUZZ" >> $GITHUB_OUTPUT
          echo "run_cve=$DO_CVE" >> $GITHUB_OUTPUT
          echo "run_graph=$DO_GRAPH" >> $GITHUB_OUTPUT

      - name: Setup node env
        uses: actions/setup-node@v3
        with:
          node-version: '23'

      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Pull dependencies
        run: |
          yarn && yarn install
          yarn pull-data
          cd importer && yarn && yarn install

      # --- MODULES (Composite Actions) ---

      - name: Run Commits Module
        if: steps.config.outputs.run_commits == 'true'
        uses: ./.github/actions/commits
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Treemap Module
        if: steps.config.outputs.run_treemap == 'true'
        uses: ./.github/actions/treemap
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Fuzz Module
        if: steps.config.outputs.run_fuzz == 'true'
        uses: ./.github/actions/fuzz
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run CVE Module
        if: steps.config.outputs.run_cve == 'true'
        uses: ./.github/actions/cve
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Graph Module
        if: steps.config.outputs.run_graph == 'true'
        uses: ./.github/actions/graph
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
